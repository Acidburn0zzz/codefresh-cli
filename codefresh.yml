# this pipeline should not be run on version tag releases (it may cause a non correct sha to override version tagged image in dockerhub)
version: "1.0"

steps:

  install_dependencies:
    title: 'Installing testing dependencies'
    image: codefresh/node-tester-image:8.8.0
    commands:
        - yarn install --frozen-lockfile

  eslint:
    title: 'Running linting logic'
    image: codefresh/node-tester-image:8.8.0
    commands:
        - yarn eslint

#  unit-tests:
#    title: 'Running unit tests'
#    image: codefresh/node-tester-image:8.8.0
#    commands:
#        - yarn test

  build_step:
    type: build
    dockerfile: Dockerfile
    image-name: codefresh/cli
    tag: ${{CF_BRANCH}}

  push_to_registry_revision:
    title: "Pushing image tagged with revision to registry"
    type: push
    candidate: ${{build_step}}
    tag: ${{CF_SHORT_REVISION}}
    registry: "CFCR"

  execute_release_pipeline:
    title: "Execute release pipeline in case version was changed"
    image: codefresh/cli
    fail_fast: false
    commands:
      - 'apk update && apk add jq'
      - 'export PACKAGE_VERSION=$(jq -r ".version" package.json)'
      - "echo Current version: $PACKAGE_VERSION"
      - "git tag $PACKAGE_VERSION && echo Running release pipeline && codefresh run 5a4c94d282ed4d00012b54e8 -b=master --detach"
    when:
      branch:
        only: [ master ]

  update_homebrew_formula:
    title: "Update Homebrew formula in case version was changed"
    image: codefresh/cli
    fail_fast: false
    commands:
      - 'apk update && apk add jq'
      - 'export PACKAGE_VERSION=$(jq -r ".version" package.json)'
      - "echo Current version: $PACKAGE_VERSION"
      - "git tag $PACKAGE_VERSION && echo Updating Homebrew formula && codefresh run 5a6f1c9804e70e0001b3acad -b=master --detach"
    when:
      branch:
        only: [ master ]
