version: '1.0'

steps:

  fail_if_not_master:
    title: "Validate running on master branch"
    image: codefresh/cli-build
    commands:
      - 'echo This pipeline should be run only on master'
      - 'exit 1'
    when:
      branch:
        ignore: [ master ]

  extract_version:
    title: "Exporting package.json version"
    image: codefresh/cli-build
    commands:
      - 'export VERSION=v$(jq -r ".version" package.json)'
      - "echo Codefresh CLI version: $VERSION"
      - "cf_export VERSION"
  
  update_brew_formula:
    title: "Updating homebrew formula"
    image: codefresh/cli-build
    commands:
      - curl -L https://github.com/codefresh-io/cli/releases/download/${{VERSION}}/codefresh-${{VERSION}}-macos-x64.tar.gz > ${{VERSION}}.tar.gz
      - echo "compute SHA256 ..."
      - SHA256="$(shasum -a 256 ./${{VERSION}}.tar.gz | awk '{print $1}')"
      - echo "generate file from template ..."
      - sed -e "s/{{ VERSION }}/${{VERSION}}/g" -e "s/{{ SHA256 }}/$SHA256/g" ./brew/template.rb > codefresh.rb
      - echo "Updating file in GitHub"
      - |
        curl -v -i -X PUT -H 'Authorization: token '${{GITHUB_TOKEN}}'' -d "{ \
          \"message\": \"update formula version ${{VERSION}}\", \
          \"content\": \"$(openssl base64 -A -in codefresh.rb)\", \
          \"sha\": $(curl -X GET https://api.github.com/repos/codefresh-io/homebrew-cli/contents/Formula/codefresh.rb | jq .sha) \
          }" https://api.github.com/repos/codefresh-io/homebrew-cli/contents/Formula/codefresh.rb
